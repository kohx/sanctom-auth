# storage

## ドライバとディスク

デフォルトドライバは`local`、そのた`s3`、`ftp`などが使える  

ディスクは`config\filesystems.php` では以下の3つのが `disks` に設定されている。

* local
* public
* s3

デフォルトはこの内の `local` が `default` に設定されて、
`.env` の `FILESYSTEM_DRIVER` に `local` が初期値として設定されている

 `config\filesystems.php`

```php
    //...
    'default' => env('FILESYSTEM_DRIVER', 'local'),
    //...
    'disks' => [
        'local' => [
            'driver' => 'local',
            'root' => storage_path('app'),
            // urlがない
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        ],

    ],
    //...
```

 `.env`

```.env
#...
FILESYSTEM_DRIVER=local
#...

```

## ローカル

コード内でのファイル操作に使われる

`root`は`storage_path('app')`が設定されているので`storage/app`以下のファイル操作が行える

### ローカル操作方法

以下のような操作が行える

* get('path+filename');
* put('path+filename', $content);
* putFile('path', 'filename');
* putFileAs('path', $file_object, 'filename');
* exists('path+filename');
* copy('path+filename', 'path+filename');
* move('path+filename', 'path+filename');
* delete('path+filename');
* makeDirectory('path');
* deleteDirectory('path');
* size('path+filename');
* files('path');
* allFiles('path');
* path('logo.jpg');

```php
/**
 * disk ドライバの指定
 * get ファイルのコンテンツを取得
 */

// ディスクを指定する場合はこのようにする
$local = Storage::disk('local')

// ファイルのコンテンツを取得
$content = $local->get('storage_app.txt');
dump($content);

// デフォルトにlocalドライバが.envで設定されているので「disk」を省略できる
$content = Storage::get('storage_app.txt');
dump($content);

/**
 * path+filenameでファイルを第2引数で指定した内容で保存
 * 成功して場合はtrueを返す
 */
$res = $local->put('storage_app_put.txt', 'put!');
dump($res);　// true

// pathで指定した場合はその場所保存、にフォルダも作成される
$res = $local->put('first/storage_app_put.txt', 'put!');
dump($res);　// true

/**
 * putFile　指定したPATHにファイルを一意のIDで保存
 * 成功した場合はファイル名を返す
 */
// ストレージに置いたsample/sample.txtをファイルオブジェクトとして取得
$file_path = storage_path('sample/sample.txt');
$tmpFile = new File($file_path);

$res = $local->putFile('', $tmpFile);
dump($res);　// LUdtfjKzqHLH6ZoFzJFApCqO2HpIK4CVzRGHD9ca.txt

$res = $local->putFile('first', $tmpFile);
dump($res);　// vmNbI0Bg3TlHE7142Qj5XnHFQyH3954KC3EobnUU.txt

/**
 * putFileAs 指定したPATHに名前おw指定して保存
 * 成功した場合はpath+filenameを返す
 */
$res = $local->putFileAs('first', $tmpFile, 'form_sample.txt');
dump($res); // first/form_sample.txt

/**
 * exists ファイルが存在するかチェック
 * あればtrueを返す
 */
$res = $local->exists('first/form_sample.txt');
dump($res); // true

/**
 * copy ファイルのコピーをpath+filename -> path+filenameで行う
 * 成功して場合はtrueを返す
 */
$res = $local->copy('first/form_sample.txt', 'first/form_sample2.txt');
dump($res); // true

/**
 * move ファイルの移動をfrom:path+filename -> to:path+filenameで行う
 * 成功して場合はtrueを返す
 */
$res = $local->move('first/form_sample.txt', 'form_to.txt');
dump($res); // true

/**
 * move ファイルの削除をpath+filenameで行う
 * 成功して場合はtrueを返す
 */
$res = $local->delete('first/form_sample2.txt');
dump($res); // true

/**
 * makeDirectory ディレクトリをpathで作成
 * 成功して場合はtrueを返す
 */
$res = $local->makeDirectory('first/second');
dump($res); // true

/**
 * deleteDirectory ディレクトリをpathで中身ごと削除
 * 成功して場合はtrueを返す
 */
$res =  $local->deleteDirectory('next');
dump($res); // true

/**
 * size ファイルをpath+filenameで指定してファイルサイズを取得
 * ファイルサイズをバイト数で返す
 */
$res = $local->size('form_to.txt');
dump($res); // 9

/**
 * files pathで指定してディレクトリの一覧を取得
 * 指定したパス内にあるフォルダは無視される
 * 配列で返す
 */
$res = $local->files('');
dump($res); // array

/**
 * allFiles　pathで指定したディレクトリ以下にある全てのファイルのpath+filenameの一覧を取得
 * 配列で返す
 */
$res = $local->allFiles('');
dump($res); // array

```

## 公開フォルダ

`root`は`storage_path('app/public')`が設定されているので`storage/app/public`以下のファイル操作が行える

 `config\filesystems.php`

```php
    //...
    'disks' => [
        //...

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            // urlを取得した場合のプレフィックス
            'url' => env('APP_URL').'/storage',
            // public、privateを設定でき：一般的に他のユーザーがアクセスできる必要を示す
            'visibility' => 'public',
        ],
    ],
    //...
```

### 公開フォルダのシンボリックリンクを作成

`config\filesystems.php` の `links` に以下のような設定があるのを確認  
初期値で `public/storage` に `storage/app/public` のシンボリックリンクを作成するようになっている  

```php
   'links' => [
        public_path('storage') => storage_path('app/public'),
    ],
```

artisanコマンドを実行して反映させる

```bash
php artisan storage:link
```

これにより`public`ディレクトリからのrulで取得できる

### 公開フォルダ操作方法

diskを指定するだけで、その他はlocalと同じ  
ファイルの'url'を取得することができる

```php
// ディスクを指定する場合はこのようにする
$public = Storage::disk('public');

/**
 * url ファイルのurlを取得
 */
$url = $public->url('asdf.txt');
dump($url); // http://localhost:3000/storage/asdf.txt
```

### 公開フォルダを追加する

`storage` の他に `images` を追加する場合  

`config\filesystems.php`

```php
    //...
    'disks' => [
        //...

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
        ],

        // 追加
        'images' => [
            'driver' => 'local',
            'root' => storage_path('app/images'),
            'url' => env('APP_URL') . '/storage',
            'visibility' => 'public',
        ],
    ],
    //...

   'links' => [
        public_path('storage') => storage_path('app/public'),
        // 追加
        public_path('images') => storage_path('app/images'),
    ],
```

artisanコマンドを実行して反映させる

```bash
php artisan storage:link
```

※ 追加した場合は`.gitignore`にシンボリックリンク先を追加しておく

`.gitignore`

```.gitignore
#...
public/storage
public/images
#...
```

## Amazon S3

`Amazon S3` と `CachedAdapter` をコンポサーでインストールする

```bash
composer require --with-all-dependencies league/flysystem-aws-s3-v3 "^1.0"
composer require league/flysystem-cached-adapter "~1.0"
```

### Amazon S3用の設定

`config\filesystems.php` の `links` に以下のような設定があるのを確認  

```php
'disks' => [
        // ...

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        ],

    ],
```

`AWS_ACCESS_KEY_ID` ,  
`AWS_SECRET_ACCESS_KEY` ,  
`AWS_DEFAULT_REGION` ,  
`AWS_BUCKET` ,  
`AWS_URL` , を `.env` で設定

```.env
AWS_ACCESS_KEY_ID=AKIAV7Z6BWDVGW53K4N6
AWS_SECRET_ACCESS_KEY=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
AWS_DEFAULT_REGION=ap-northeast-1
AWS_BUCKET=campox
AWS_URL=https://s3-ap-northeast-1.amazonaws.com/campox/
AWS_USE_PATH_STYLE_ENDPOINT=false
```

### 公開フォルダ操作方法

diskを指定するだけで、その他はlocalと同じ  
ファイルの'url'を取得することができる

```php
// ディスクを指定する場合はこのようにする
$s3 = Storage::disk('s3');

$res = $s3->put('first/storage_app_put.txt', 'put　to s3');
$url = $s3->url('asdf.txt');
dump($url);
```
