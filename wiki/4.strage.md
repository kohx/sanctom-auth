# storage

## 公開ディスク

### 公開ディスク用の設定

`config\filesystems.php` の `links` に以下のような設定があるのを確認  
デフォルトで `public/storage` に `storage/app/public` のシンボリックリンクを作成するようになっている  

```php
   'links' => [
        public_path('storage') => storage_path('app/public'),
    ],
```

artisanでリンクを作成する

```bash
php artisan storage:link
```

### FILESYSTEM_DRIVERの設定

わかりやすいようにデフォルトは`local`にしておく  
開発で`local`本番で`s3`のように運用する場合は`.env`で切り替える用に設定する

```.env
FILESYSTEM_DRIVER=local
```

### 公開するフォルダを使用する

`storage` の他に `images` を追加する場合  

```php
   'links' => [
        public_path('storage') => storage_path('app/public'),
        public_path('images') => storage_path('app/images'),
    ],
```

### 公開ディスク用使用方法

* get('logo.jpg') : ファイルを取得します
* put('logo.jpg', $fileContent) : ファイルを保存します。
* putFile(PATH, $file) : 指定したPATHにファイルを保存。名前は一意のIDです。
* putFileAs(PATH, $file, 'logo.jpg') : 指定したPATHにlogo.jpgという名前ファイルを保存します。
* exists('logo.jpg') : ファイルが存在するかチェックを行います。あればtrueが返されます。
* copy('logo.jpg', 'new_logo.jpg') : ファイルのコピーを行います。
* move('logo.jpg, 'new_logo.jpg') : ファイルの移動を行います。
* delete('logo.jpg') : ファイルの削除を行います。
* makeDirectory('image') : ディレクトリを作成します。
* deleteDirectory('image') : ディレクトリを削除します。
* size('logo.jpg') : ファイルのサイズを確認します。
* files('public') : publicディレクトリにあるファイルのみ表示します。
* allFiles('public') : publicディレクトリ以下のすべてのファイルとディレクトリを表示します。ファイル、ディレクトリがたくさんある場合は時間がかかります。
* path('logo.jpg') : ファイルのフルパスを表示します。ファイル名をfalseにするとrootパスが表示されます。

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class CheckController extends Controller
{
    public function index(Request $request)
    {
        // assetでURLを取得
        $file = asset('storage/file.txt');
        dump($file);
        $image = asset('images/test.jpg');
        dump($image);
    }
}
```

## Amazon S3

`Amazon S3` と `CachedAdapter` をコンポサーでインストールする

```bash
composer require --with-all-dependencies league/flysystem-aws-s3-v3 "^1.0"
composer require league/flysystem-cached-adapter "~1.0"
```

### Amazon S3用の設定

`config\filesystems.php` の `links` に以下のような設定があるのを確認  

```php
'disks' => [
        // ...

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
        ],

    ],
```

`AWS_ACCESS_KEY_ID` , 
`AWS_SECRET_ACCESS_KEY` , 
`AWS_DEFAULT_REGION` , 
`AWS_BUCKET` , 
`AWS_URL` , を `.env` で設定

```.env
AWS_ACCESS_KEY_ID=AKIAV7Z6BWDVGW53K4N6
AWS_SECRET_ACCESS_KEY=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
AWS_DEFAULT_REGION=ap-northeast-1
AWS_BUCKET=campox
AWS_URL=https://s3-ap-northeast-1.amazonaws.com/campox/
AWS_USE_PATH_STYLE_ENDPOINT=false
```
